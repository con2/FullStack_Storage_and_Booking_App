# Supabase Setup Guide

This document provides step-by-step instructions for setting up Supabase for the Storage and Booking Application.

## Table of Contents

- [Initial Setup](#initial-setup)
- [Database Configuration](#database-configuration)
- [Authentication Setup](#authentication-setup)
- [Storage Configuration](#storage-configuration)
- [API Access Configuration](#api-access-configuration)
- [Environment Variables](#environment-variables)
- [Local Development](#local-development)
- [Database Extensions](#database-extensions)
- [Common Issues](#common-issues)

## Initial Setup

### Creating a Supabase Project

1. **Create a Supabase account**:

   - Go to [supabase.com](https://supabase.com)
   - Sign up or log in with GitHub or email

2. **Create a new project**:

   - Click "New Project"
   - Choose a name for your project (e.g., "storage-booking-app")
   - Set a secure database password
   - Choose a region closest to your target audience
   - Click "Create new project"

3. **Get your API credentials**:
   - Once the project is created, go to Project Settings > API
   - Copy the following values:
     - Project URL
     - Project API keys (anon key and service role key)

### Setting up Environment Variables

Create or update your `.env.local` file with the Supabase credentials:

```bash
# Supabase Configuration
SUPABASE_PROJECT_ID=your-project-id
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
SUPABASE_URL=https://${SUPABASE_PROJECT_ID}.supabase.co

# Frontend Configuration
VITE_SUPABASE_URL=${SUPABASE_URL}
VITE_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
```

## Database Configuration

### Setting up Database Schema

1. **Access the SQL Editor**:

   - Navigate to the SQL Editor in the Supabase Dashboard

2. **Execute Schema Creation SQL**:

   - Run the table creation scripts in this order:

   ```sql
   -- Execute tablesCreateStatements.sql first
   -- This creates all the tables required by the application
   ```

3. **Set up Row Level Security**:

   - Execute the RLS setup script:

   ```sql
   -- Execute setUpRowLevelSecurity.sql
   -- This sets up access policies for various roles
   ```

4. **Create Indexes**:

   - Set up database indexes for better performance:

   ```sql
   -- Execute createIndexes.sql
   -- This creates indexes for frequently queried columns
   ```

5. **Set up Functions**:

   - Create database functions for business logic:

   ```sql
   -- Execute functions/autoGeneratedFields.sql
   -- This creates functions for calculating ratings, inventory management, etc.

   -- Execute functions/auditTrigger.sql (if exists)
   -- This sets up audit logging
   ```

### Database Schema Verification

After executing the scripts, verify the database objects:

1. Navigate to "Table Editor" in the Supabase Dashboard
2. Confirm that all tables have been created correctly
3. Check that RLS is enabled on all tables
4. Verify that functions and triggers are set up properly

## Authentication Setup

Supabase provides built-in authentication functionality:

### Configure Auth Settings

1. **Set up Email Templates**:

   - Go to Authentication > Email Templates
   - Customize the templates for:
     - Invitation
     - Magic Link
     - Password Recovery
     - Email Change Confirmation

2. **Configure Auth Providers**:

   - Go to Authentication > Providers
   - Enable the Email provider
   - Configure additional providers if needed (e.g., Google, GitHub)

3. **Set up URL Configuration**:
   - Go to Authentication > URL Configuration
   - Set Site URL to your frontend URL (e.g., http://localhost:5180 for development)
   - Set Redirect URLs to include your authorized redirect paths:
     - http://localhost:5180/auth/callback
     - https://your-production-domain.com/auth/callback (for production)

### Email Confirmation

For email verification:

1. Go to Authentication > Providers
2. Under Email, toggle "Enable email confirmations"
3. Configure "Confirm email template"

## Storage Configuration

Supabase Storage is used for file uploads (like item images and invoices):

### Create Storage Buckets

1. Navigate to Storage in the Supabase Dashboard
2. Create the following buckets:

   a. **item-images**:

   - Click "Create Bucket"
   - Enter name: "item-images"
   - Set access: Private (recommended)

   b. **invoices**:

   - Click "Create Bucket"
   - Enter name: "invoices"
   - Set access: Private

### Configure Bucket Policies

For the item-images bucket:

1. Go to the bucket and click "Policies"
2. Create policies for:
   - **Public Access**: Allow anyone to retrieve images
   - **Admin Upload**: Allow admins to upload/delete images

Example policy for public image access:

```sql
CREATE POLICY "Allow public access to item images"
ON storage.objects FOR SELECT
USING (bucket_id = 'item-images');
```

Example policy for admin control:

```sql
CREATE POLICY "Allow admins to manage item images"
ON storage.objects FOR ALL
USING (
  bucket_id = 'item-images' AND
  (SELECT role FROM public.user_profiles WHERE id = auth.uid()) IN ('admin', 'superVera')
);
```

For the invoices bucket (more restricted):

```sql
CREATE POLICY "Allow admins to manage invoices"
ON storage.objects FOR ALL
USING (
  bucket_id = 'invoices' AND
  (SELECT role FROM public.user_profiles WHERE id = auth.uid()) IN ('admin', 'superVera')
);
```

## API Access Configuration

Configure API settings for secure access:

### CORS Configuration

1. Go to Project Settings > API
2. Under API Settings, configure CORS:
   - Add your frontend URL to "Allow origins" (e.g., http://localhost:5180)
   - Enable "Allow credentials"

### API Authorization

Configure authorization rules for service role access:

1. Go to Project Settings > API
2. Review the JWT secret (used for token verification)
3. Set appropriate expiry for JWTs (default is 3600 seconds)

## Environment Variables

Ensure you have all necessary environment variables configured:

### Backend Environment Variables

```bash
SUPABASE_PROJECT_ID=your-project-id
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
SUPABASE_URL=https://${SUPABASE_PROJECT_ID}.supabase.co
```

### Frontend Environment Variables

```bash
VITE_SUPABASE_URL=https://your-project-id.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
VITE_API_URL=http://localhost:3000
```

### Storage Configuration

```bash
SUPABASE_STORAGE_URL=https://your-project-id.supabase.co/storage/v1/s3
S3_REGION=your-region
S3_BUCKET=item-images
```

## Local Development

### Using Supabase CLI

1. **Install the Supabase CLI**:

```bash
npm install -g supabase
```

2. **Login to Supabase CLI**:

```bash
supabase login
```

3. **Link your project**:

```bash
supabase link --project-ref your-project-id --password your-db-password
```

4. **Pull database schema locally**:

```bash
supabase db pull
```

5. **Run database migrations**:

```bash
supabase db push
```

### Local Development Workflow

1. **Local API testing**:

   - Start your backend: `npm run start` from the backend directory
   - Use the Supabase client in your code to connect to your remote project

2. **Viewing logs**:
   - Access Supabase logs from the Dashboard
   - Review function logs, auth logs, and database logs

## Database Extensions

Enable necessary PostgreSQL extensions:

### Required Extensions

1. **pg_net** (for HTTP requests):

```sql
CREATE EXTENSION IF NOT EXISTS pg_net;
```

2. **uuid-ossp** (for UUID generation):

```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

## Common Issues

### Authentication Issues

1. **CORS Errors**: Ensure your frontend domain is added to allowed origins in the API settings.

2. **JWT Token Issues**: Check token expiry settings and verify that the JWT secret is correctly configured.

### Database Access Issues

1. **Row Level Security Blocking Access**: Verify that appropriate RLS policies are in place for your use cases.

2. **Permission Errors**: Make sure you're using the correct API key (anonymous vs service role) for the operation.

### Storage Issues

1. **Upload Failures**: Check bucket policies and ensure users have the necessary permissions.

2. **Access Denied**: Verify RLS policies on the storage.objects table and ensure signed URLs are used where appropriate.

### Function Issues

1. **Function Not Found**: Ensure all required extensions are enabled.

2. **Permission Denied**: Check that functions are created with the appropriate security context (SECURITY DEFINER vs INVOKER).
